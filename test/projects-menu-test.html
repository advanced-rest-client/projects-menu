<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
    <script src="../../webcomponentsjs/webcomponents-loader.js"></script>
    <script src="../../web-component-tester/browser.js"></script>
    <link rel="import" href="../../arc-data-generator/arc-data-generator.html">
    <link rel="import" href="../../arc-models/request-model.html">
    <link rel="import" href="../../arc-models/project-model.html">
    <link rel="import" href="../../iron-test-helpers/mock-interactions.html">
    <link rel="import" href="../projects-menu.html">
  </head>
  <body>
    <request-model></request-model>
    <project-model></project-model>

    <test-fixture id="Basic">
      <template>
        <projects-menu no-auto-projects></projects-menu>
      </template>
    </test-fixture>

    <test-fixture id="Role">
      <template>
        <projects-menu role="main" no-auto-projects></projects-menu>
      </template>
    </test-fixture>

    <test-fixture id="Comfortable">
      <template>
        <projects-menu list-type="comfortable" no-auto-projects></projects-menu>
      </template>
    </test-fixture>

    <test-fixture id="Compact">
      <template>
        <projects-menu list-type="compact" no-auto-projects></projects-menu>
      </template>
    </test-fixture>

    <test-fixture id="Default">
      <template>
        <projects-menu list-type="default" no-auto-projects></projects-menu>
      </template>
    </test-fixture>
    <script>
    /* global DataGenerator, MockInteractions */
    suite('role attribute', () => {
      test('Sets role attribute', () => {
        const element = fixture('Basic');
        assert.equal(element.getAttribute('role'), 'menu');
      });

      test('Accepts existing role', () => {
        const element = fixture('Role');
        assert.equal(element.getAttribute('role'), 'main');
      });
    });

    suite('List types computations', () => {
      const iconWidthProperty = '--paper-item-icon-width';
      const iconWidths = ['56px', '48px', '36px'];

      test(`Icon width is not set for inital list style`, (done) => {
        const element = fixture('Basic');
        flush(() => {
          let style;
          if (window.ShadyCSS) {
            style = window.ShadyCSS.getComputedStyleValue(element, iconWidthProperty);
          } else {
            style = getComputedStyle(element).getPropertyValue(iconWidthProperty);
          }
          assert.equal(style.trim(), '');
          done();
        });
      });

      test(`Icon width is ${iconWidths[0]} for "default" list style`, (done) => {
        let style;
        const element = fixture('Default');
        flush(() => {
          if (window.ShadyCSS) {
            style = window.ShadyCSS.getComputedStyleValue(element, iconWidthProperty);
          } else {
            style = getComputedStyle(element).getPropertyValue(iconWidthProperty);
          }
          assert.equal(style.trim(), iconWidths[0]);
          done();
        });
      });

      test(`Icon width is ${iconWidths[1]} for "Comfortable" list style`, (done) => {
        let style;
        const element = fixture('Comfortable');
        flush(() => {
          if (window.ShadyCSS) {
            style = window.ShadyCSS.getComputedStyleValue(element, iconWidthProperty);
          } else {
            style = getComputedStyle(element).getPropertyValue(iconWidthProperty);
          }
          assert.equal(style, iconWidths[1]);
          done();
        });
      });

      test(`Icon width is ${iconWidths[2]} for "Comfortable" list style`, (done) => {
        let style;
        const element = fixture('Compact');
        flush(() => {
          if (window.ShadyCSS) {
            style = window.ShadyCSS.getComputedStyleValue(element, iconWidthProperty);
          } else {
            style = getComputedStyle(element).getPropertyValue(iconWidthProperty);
          }
          assert.equal(style, iconWidths[2]);
          done();
        });
      });
    });

    suite('_computeDataUnavailable()', () => {
      let element;
      setup(() => {
        element = fixture('Basic');
      });

      test('Returns true when argument is false', () => {
        assert.isTrue(element._computeDataUnavailable(false));
      });

      test('Returns false when argument is true', () => {
        assert.isFalse(element._computeDataUnavailable(true));
      });
    });

    suite('_computeA11yCommand()', () => {
      let element;
      setup(() => {
        element = fixture('Basic');
      });

      test('Returns a string with the key', () => {
        const result = element._computeA11yCommand('s');
        assert.typeOf(result, 'string');
        assert.isTrue(/[ctrl|meta]\+s/.test(result));
      });

      test('Returns mac+letter for mac platform', () => {
        const result = element._computeA11yCommand('s', 'Mac');
        assert.typeOf(result, 'string');
        assert.isTrue(/meta\+s/.test(result));
      });

      test('Returns ctrl+letter for other platforms', () => {
        const result = element._computeA11yCommand('s', 'Other');
        assert.typeOf(result, 'string');
        assert.isTrue(/ctrl\+s/.test(result));
      });
    });

    suite('_cancelEvent()', () => {
      let element;
      setup(() => {
        element = fixture('Basic');
      });

      test('Calls preventDefault()', () => {
        let called;
        const e = {
          preventDefault: () => called = true,
          stopPropagation: () => {},
          stopImmediatePropagation: () => {}
        };
        element._cancelEvent(e);
        assert.isTrue(called);
      });

      test('Calls preventDefault()', () => {
        let called;
        const e = {
          preventDefault: () => {},
          stopPropagation: () => called = true,
          stopImmediatePropagation: () => {}
        };
        element._cancelEvent(e);
        assert.isTrue(called);
      });

      test('Calls stopImmediatePropagation()', () => {
        let called;
        const e = {
          preventDefault: () => {},
          stopPropagation: () => {},
          stopImmediatePropagation: () => called = true
        };
        element._cancelEvent(e);
        assert.isTrue(called);
      });
    });

    suite('_moreClickHandler()', () => {
      let element;
      setup(() => {
        element = fixture('Basic');
      });

      test('Calls _cancelEvent()', () => {
        const e = {
          preventDefault: () => {},
          stopPropagation: () => {},
          stopImmediatePropagation: () => {}
        };
        const spy = sinon.spy(element, '_cancelEvent');
        element._moreClickHandler(e);
        assert.isTrue(spy.called);
      });
    });

    suite('_dispatchOpenRequests()', () => {
      let element;
      setup(() => {
        element = fixture('Basic');
      });

      test('Dispatches workspace-open-project-requests event', () => {
        const project = DataGenerator.createProjectObject();
        const spy = sinon.spy();
        element.addEventListener('workspace-open-project-requests', spy);
        element._dispatchOpenRequests(project, false);
        assert.isTrue(spy.called);
      });

      test('Returns the event', () => {
        const project = DataGenerator.createProjectObject();
        const e = element._dispatchOpenRequests(project, false);
        assert.typeOf(e, 'customevent');
        assert.equal(e.type, 'workspace-open-project-requests');
      });

      test('Event has project data', () => {
        const project = DataGenerator.createProjectObject();
        const e = element._dispatchOpenRequests(project, false);
        assert.deepEqual(e.detail.project, project);
      });

      test('Event has replace flage', () => {
        const project = DataGenerator.createProjectObject();
        const e = element._dispatchOpenRequests(project, false);
        assert.isFalse(e.detail.replace);
      });
    });

    suite('_deselectMenuOption()', () => {
      suiteSetup(() => {
        return DataGenerator.insertSavedRequestData();
      });

      suiteTeardown(() => {
        return DataGenerator.destroySavedRequestData();
      });

      let element;
      setup((done) => {
        element = fixture('Basic');
        element._updateProjectsList()
        .then(() => {
          flush(() => {
            done();
          });
        });
      });

      test('Calls _deselectMenuOption()', () => {
        const item = element.shadowRoot.querySelector('paper-listbox paper-item');
        const spy = sinon.spy(element, '_deselectMenuOption');
        MockInteractions.tap(item);
        assert.isTrue(spy.called);
      });

      test('Selected menu from menu item click event', () => {
        const menu = element.shadowRoot.querySelector('paper-listbox');
        menu.selected = 1;
        const item = menu.querySelector('paper-item');
        MockInteractions.tap(item);
        assert.equal(menu.selected, -1);
      });
    });

    suite('_openProject()', () => {
      suiteSetup(() => {
        return DataGenerator.insertSavedRequestData();
      });

      suiteTeardown(() => {
        return DataGenerator.destroySavedRequestData();
      });

      let element;
      setup((done) => {
        element = fixture('Basic');
        element._updateProjectsList()
        .then(() => {
          flush(() => {
            done();
          });
        });
      });

      test('Calls _openProject() when menu item click', () => {
        const item = element.shadowRoot.querySelectorAll('paper-listbox paper-item')[0];
        const spy = sinon.spy(element, '_openProject');
        MockInteractions.tap(item);
        assert.isTrue(spy.called);
      });

      test('Calls _cancelEvent()', () => {
        const item = element.shadowRoot.querySelectorAll('paper-listbox paper-item')[0];
        const spy = sinon.spy(element, '_cancelEvent');
        MockInteractions.tap(item);
        assert.isTrue(spy.called);
      });

      test('Calls _deselectMenuOption()', () => {
        const item = element.shadowRoot.querySelectorAll('paper-listbox paper-item')[0];
        const spy = sinon.spy(element, '_deselectMenuOption');
        MockInteractions.tap(item);
        assert.isTrue(spy.called);
      });

      test('Menu option is deselected', () => {
        const menu = element.shadowRoot.querySelector('paper-listbox');
        menu.selected = 1;
        const item = menu.querySelector('paper-item');
        MockInteractions.tap(item);
        assert.equal(menu.selected, -1);
      });

      test('Dispatches navigate event', () => {
        const item = element.shadowRoot.querySelectorAll('paper-listbox paper-item')[0];
        const spy = sinon.spy();
        element.addEventListener('navigate', spy);
        MockInteractions.tap(item);
        assert.isTrue(spy.called);
      });

      test('The event has base set', () => {
        const item = element.shadowRoot.querySelectorAll('paper-listbox paper-item')[0];
        const spy = sinon.spy();
        element.addEventListener('navigate', spy);
        MockInteractions.tap(item);
        assert.equal(spy.args[0][0].detail.base, 'project');
      });

      test('The event has type set', () => {
        const item = element.shadowRoot.querySelectorAll('paper-listbox paper-item')[0];
        const spy = sinon.spy();
        element.addEventListener('navigate', spy);
        MockInteractions.tap(item);
        assert.equal(spy.args[0][0].detail.type, 'details');
      });

      test('The event has id set', () => {
        const item = element.shadowRoot.querySelectorAll('paper-listbox paper-item')[0];
        const spy = sinon.spy();
        element.addEventListener('navigate', spy);
        MockInteractions.tap(item);
        assert.typeOf(spy.args[0][0].detail.id, 'string');
      });
    });

    suite('_openAllRequests()', () => {
      suiteSetup(() => {
        return DataGenerator.insertSavedRequestData();
      });

      suiteTeardown(() => {
        return DataGenerator.destroySavedRequestData();
      });

      let element;
      setup((done) => {
        element = fixture('Basic');
        element._updateProjectsList()
        .then(() => {
          flush(() => {
            done();
          });
        });
      });

      test('Calls _cancelEvent()', () => {
        const item = element.shadowRoot.querySelectorAll('paper-listbox paper-item')[1];
        const spy = sinon.spy(element, '_cancelEvent');
        MockInteractions.tap(item);
        assert.isTrue(spy.called);
      });

      test('Calls _deselectMenuOption()', () => {
        const item = element.shadowRoot.querySelectorAll('paper-listbox paper-item')[1];
        const spy = sinon.spy(element, '_deselectMenuOption');
        MockInteractions.tap(item);
        assert.isTrue(spy.called);
      });

      test('Menu option is deselected', () => {
        const menu = element.shadowRoot.querySelector('paper-listbox');
        menu.selected = 1;
        const item = menu.querySelectorAll('paper-item')[1];
        MockInteractions.tap(item);
        assert.equal(menu.selected, -1);
      });

      test('Calls _dispatchOpenRequests() when menu item click', () => {
        const item = element.shadowRoot.querySelectorAll('paper-listbox paper-item')[1];
        const spy = sinon.spy(element, '_dispatchOpenRequests');
        MockInteractions.tap(item);
        assert.isTrue(spy.called);
      });

      test('project argument is set', () => {
        const item = element.shadowRoot.querySelectorAll('paper-listbox paper-item')[1];
        const spy = sinon.spy(element, '_dispatchOpenRequests');
        MockInteractions.tap(item);
        assert.typeOf(spy.args[0][0], 'object');
      });

      test('replace argument is set', () => {
        const item = element.shadowRoot.querySelectorAll('paper-listbox paper-item')[1];
        const spy = sinon.spy(element, '_dispatchOpenRequests');
        MockInteractions.tap(item);
        assert.isFalse(spy.args[0][1]);
      });

      test('Dispatches workspace-open-project-request event', () => {
        const item = element.shadowRoot.querySelectorAll('paper-listbox paper-item')[1];
        const spy = sinon.spy();
        element.addEventListener('workspace-open-project-requests', spy);
        MockInteractions.tap(item);
        assert.isTrue(spy.called);
      });
    });

    suite('_replaceAllRequests()', () => {
      suiteSetup(() => {
        return DataGenerator.insertSavedRequestData();
      });

      suiteTeardown(() => {
        return DataGenerator.destroySavedRequestData();
      });

      let element;
      setup((done) => {
        element = fixture('Basic');
        element._updateProjectsList()
        .then(() => {
          flush(() => {
            done();
          });
        });
      });

      test('Calls _cancelEvent()', () => {
        const item = element.shadowRoot.querySelectorAll('paper-listbox paper-item')[2];
        const spy = sinon.spy(element, '_cancelEvent');
        MockInteractions.tap(item);
        assert.isTrue(spy.called);
      });

      test('Calls _deselectMenuOption()', () => {
        const item = element.shadowRoot.querySelectorAll('paper-listbox paper-item')[2];
        const spy = sinon.spy(element, '_deselectMenuOption');
        MockInteractions.tap(item);
        assert.isTrue(spy.called);
      });

      test('Menu option is deselected', () => {
        const menu = element.shadowRoot.querySelector('paper-listbox');
        menu.selected = 1;
        const item = menu.querySelectorAll('paper-item')[2];
        MockInteractions.tap(item);
        assert.equal(menu.selected, -1);
      });

      test('Calls _dispatchOpenRequests() when menu item click', () => {
        const item = element.shadowRoot.querySelectorAll('paper-listbox paper-item')[2];
        const spy = sinon.spy(element, '_dispatchOpenRequests');
        MockInteractions.tap(item);
        assert.isTrue(spy.called);
      });

      test('project argument is set', () => {
        const item = element.shadowRoot.querySelectorAll('paper-listbox paper-item')[2];
        const spy = sinon.spy(element, '_dispatchOpenRequests');
        MockInteractions.tap(item);
        assert.typeOf(spy.args[0][0], 'object');
      });

      test('replace argument is set', () => {
        const item = element.shadowRoot.querySelectorAll('paper-listbox paper-item')[2];
        const spy = sinon.spy(element, '_dispatchOpenRequests');
        MockInteractions.tap(item);
        assert.isTrue(spy.args[0][1]);
      });

      test('Dispatches workspace-open-project-request event', () => {
        const item = element.shadowRoot.querySelectorAll('paper-listbox paper-item')[2];
        const spy = sinon.spy();
        element.addEventListener('workspace-open-project-requests', spy);
        MockInteractions.tap(item);
        assert.isTrue(spy.called);
      });
    });

    suite('_toggleOpen()', () => {
      suiteSetup(() => {
        return DataGenerator.insertSavedRequestData();
      });

      suiteTeardown(() => {
        return DataGenerator.destroySavedRequestData();
      });

      let element;
      setup((done) => {
        element = fixture('Basic');
        element._updateProjectsList()
        .then(() => {
          flush(() => {
            done();
          });
        });
      });

      test('Toggles item open when clicked on the container', () => {
        const node = element.shadowRoot.querySelector('.project-item-wrapper');
        const target = node.querySelector('.project-item');
        const tpl = node.querySelector('.requests-condition');
        assert.isUndefined(tpl.if);
        MockInteractions.tap(target);
        assert.isTrue(tpl.if);
      });

      test('Toggles item open when clicked on a child element of the container', () => {
        const node = element.shadowRoot.querySelector('.project-item-wrapper');
        const target = node.querySelector('.project-name');
        const tpl = node.querySelector('.requests-condition');
        assert.isUndefined(tpl.if);
        MockInteractions.tap(target);
        assert.isTrue(tpl.if);
      });

      test('Toggles item open closed', () => {
        const node = element.shadowRoot.querySelector('.project-item-wrapper');
        const target = node.querySelector('.project-item');
        const tpl = node.querySelector('.requests-condition');
        tpl.if = true;
        MockInteractions.tap(target);
        assert.isFalse(tpl.if);
      });
    });
    </script>

  </body>
</html>
